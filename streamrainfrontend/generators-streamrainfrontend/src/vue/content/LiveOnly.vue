<template>
<div class="container-fluid text-left" style="width:95%">
	
<div class="col-md-12">
	<div style="text-align:right">
		<button type="button" class="btn btn-default" @click="cargardatos()" > Cargar Datos Demo</button>
	</div>
  </div>

	<form enctype="multipart/form-data" @submit.prevent="crearContenidoLive()">

	<div id="basic-form" >
		<div class="form-group">
			<label>Nombre</label>
			<input type="text" class="form-control" v-model="name" required>
		</div>
	</div>

	<div class="form-group">
		<label>Descripcion</label>
		<textarea class="form-control" rows="5" cols="30" v-model="description" required></textarea>
	</div>

	<div class="form-group">
		<label>Tipo</label>
		<br />
		<label class="fancy-radio">
			<input type="radio" name="tipo" value="3" v-model="type">
			<span><i></i>Evento Deportivo</span>
		</label>

		<label class="fancy-radio">
			<input type="radio" name="tipo" value="4" v-model="type">
			<span><i></i>Evento Espectaculo</span>
		</label>
	</div>
	
<div class="form-group">

<label for="live-picker" class="form-group">Fecha y hora de inicio (LIVE)</label>
	<datetime v-model="dateStart" name="live-picker"
		type="datetime"
		input-format="DD-MM-YYYY HH:mm"
		placeholder=""
		locale="es"
		required ></datetime>

</div>

	<div class="form-group">
		<label>Duracion Estimada (minutos)</label>
		<input type="number" class="form-control" v-model="estimatedDuraction" required>
	</div>

	<div class="form-group">
		<label for="picture" class="control-label">Picture</label>
		<input type="file" @change="subirArchivo('picture', $event.target.files)" class="input-file">
	</div>  


	
	<div class="form-group">
		<label>Categorias</label>
		<div v-for = "c in categorias">
		<label  class="fancy-checkbox">
			<input type="checkbox" :value="c.id" v-model="idCategories">
			<span> {{ c.name }} </span>
		</label>
		</div>
	</div>

	<div class="form-group" v-if="type==4">
		<label for="directores" class="control-label">Directores</label>
		<br>
		<input type="text"  v-model="nombreDirector"  placeholder="Nombre">
		<input type="text"  v-model="apellidoDirector"  placeholder="Apellido">
		<button type="button" @click="guardarDirector(nombreDirector,apellidoDirector)"> Agregar </button>
	</div>

	<div class="form-group" v-if="type==4">
		<ul v-for="d in directors" class="list-group">
			<li class="list-group-item">
				<a class="fa fa-times" aria-hidden="true"  @click="eliminarDirector(d)"></a>
				{{d.firstName}}  {{d.lastName}}
			</li>
		</ul> 
	</div>

	<div class="form-group" v-if="type==4">
		<label for="actores" class="control-label">Actores</label>
		<br>
		<input type="text"   v-model="nombreActor"  placeholder="Nombre">
		<input type="text"  v-model="apellidoActor"  placeholder="Apellido">
		<button type="button" @click="guardarActor(nombreActor,apellidoActor)"> Agregar </button>
	</div>

	<div class="form-group" v-if="type==4">
		<ul v-for="a in actors" class="list-group">
			<li class="list-group-item">
				<a class="fa fa-times" aria-hidden="true"  @click="eliminarActor(a)"></a>
				{{a.firstName}}  {{a.lastName}}
			</li>
		</ul> 
	</div>

	<div class="form-group">
		<label>Contenidos Similares</label>
		<multi-select :options="options"
			:selected-options="idSimilarContents"
			placeholder="seleccionar contenidos similares"
			@select="onSelect">
		</multi-select>
	</div>		

<div class="form-group">
<label class="fancy-checkbox">
	<input type="checkbox" v-model="isPayPerView">
	<span>Pay Per View (PPV)</span>
</label>
</div>

	<div class="form-group">
<label class="fancy-checkbox">
	<input type="checkbox" v-model="featured">
	<span>Destacado</span>
</label>
</div>


	<div v-if="featured">

		<label for="start-picker" class="col-sm-3 control-label">Desde: </label>
		<div class='input-group date'>
			<datetime v-model="featuredDateStart" name="start-picker"
				type="datetime"
				input-format="DD-MM-YYYY HH:mm"
				placeholder=""
				locale="es"
				required ></datetime>
		</div>

<br>

		<label for="end-picker" class="col-sm-3 control-label">	Hasta: </label>
		<div class='input-group date'>
			
			<datetime v-model="featuredDateFinish" name="end-picker" 
			type="datetime"
			input-format="DD-MM-YYYY HH:mm"
			placeholder=""
			locale="es"
			required ></datetime>
    	</div>
	</div>
	
	<div style="text-align:right">
		<button type="submit" class="btn btn-primary" :disabled="!buttonEnable">{{ buttonText }} <i v-if="!buttonEnable" class="fa fa-spinner fa-spin" style="font-size"></i></button>
	</div>

	</form>

</div>
</template>

<script>
import _ from 'lodash';
import { MultiSelect } from 'vue-search-select';

export default {
	components: {
     MultiSelect
  },
	props: [
    'config',
	'eventBus',
	'session'
  ],
	data () {
		return {
			// json datos
			name:'',
			description: '',
			type: '',
			dateStart: '',
			estimatedDuraction: 0,
			idCategories: [],
			directors: [],
			actors: [],
			idSimilarContents: [],
			idSimilarContentsIDS: [],
			isPayPerView: false,
			featured: false,
			featuredDateStart: '',  
			featuredDateFinish: '',
			//picture, video
			formData: new FormData(),

			// datos auxiliares
			categorias: [],
			nombreDirector: '',
			apellidoDirector: '',
			nombreActor: '',
			apellidoActor: '',
			options: [],
			searchText: '', 
			lastSelectItem: {},

			buttonEnable: true,
      		buttonText: 'Guardar LIVE'
		}
	},
	created () {
			this.getCategories();
			this.getContents();
    },
	methods: {
		cargardatos () {
		this.name = 'Defensa TSI203';
		this.description='Presentacion Final de la plataforma StreamRain';
		this.type = '4';
		this.estimatedDuraction = 25;
		this.dateStart = '2017-11-29T18:20:10';
		this.directors.push({firstName: 'Gustavo', lastName: 'Guimerans', isActor:false, isDirector:true});
		this.actors.push({"firstName": "Daniel", "lastName": "Martinez", "isActor":true, "isDirector":false});
		this.actors.push({"firstName": "Santiago", "lastName": "Marquez", "isActor":true, "isDirector":false});
		this.actors.push({"firstName": "Juan", "lastName": "Bonhomme", "isActor":true, "isDirector":false});
		this.actors.push({"firstName": "Gabriel", "lastName": "Sanchez", "isActor":true, "isDirector":false});

		},
		getContents () {
			const i = this;
			i.$http.get(`${i.config.backend}/generator/createContent`,
			{
				headers: { 
					'Authorization': i.session.token
					}
			}).then((result) => {
				// [{"id":1,"name":"Pelicula 1",...},{"id":2,"name":"Pelicula 2",..}]	
			for (var i = 0; i < result.body.length; i++){
						var content = result.body[i];
						var idC;
						var nameC;
						for (var key in content){
							var value = content[key];
							if (key === 'id') {
									idC = value;
							}
							if (key === 'name') {
									nameC = value;
							}
						}
						this.options.push({value: idC, text: nameC})	
				}
			})
		},		
		getCategories () {
			const i = this;
			i.$http.get(`${i.config.backend}/generator/category`,
			{
				headers: {
					'Authorization': i.session.token
				}
			}
			)
			.then((result) => {
				// [{"id":1,"name":"Terror","description":"Me asusto...","coverPictureUrl":null},{"id":2,"name":"Futbol","description":"Copa Mundial de Rusia en vivo","coverPictureUrl":null}]	
			for (var i = 0; i < result.body.length; i++){
						var cat = result.body[i];
						var idC;
						var nameC;
						for (var key in cat){
							var value = cat[key];
							if (key === 'id') {
									idC = value;
							}
							if (key === 'name') {
									nameC = value;
							}
						}
						this.categorias.push({id: idC, name: nameC})
				}
			})
		},
		onSelect (idSimilarContents, lastSelectItem) {
        	this.idSimilarContents = idSimilarContents
        	this.lastSelectItem = lastSelectItem
      	},
      // deselect option
      reset () {
        this.idSimilarContents = [] // reset
      },
      // select option from parent component
      selectOption () {
        this.idSimilarContents = _.unionWith(this.idSimilarContents, [this.options[0]], _.isEqual)
      },
		subirArchivo(fieldName, fileList) {	    
			this.formData.append(fieldName, fileList[0], fileList[0].name);
			this.formData.append('video', fileList[0], fileList[0].name);
      	},
		crearContenidoLive() {
		if (!this.buttonEnable) return;
			const updateButtonEnable = this.updateButtonEnable;
			const updateButtonText = this.updateButtonText;
			
			if (this.buttonEnable) {
          		updateButtonEnable(false);
          		updateButtonText('Please wait... ');  
			for (var i = 0; i < this.idSimilarContents.length; i++){
						var idsc = this.idSimilarContents[i];
						var idc;
						for (var key in idsc){
							var id = idsc[key];
							if (key === 'value') {
									this.idSimilarContentsIDS.push(id)
							}
						}
						
				}

			const datos = JSON.parse('{'
					+`"name":"${this.name}",`
					+`"description":"${this.description}",`
					+`"type":"${this.type}",`
					+`"dateStart":"${this.dateStart}",`
					+`"estimatedDuraction":${this.estimatedDuraction},`
					+`"idCategories":${JSON.stringify(this.idCategories)},`
					+`"directors":${JSON.stringify(this.directors)},`
					+`"actors":${JSON.stringify(this.actors)},`
					+`"idSimilarContents":${JSON.stringify(this.idSimilarContentsIDS)},`
					+`"isPayPerView":${this.isPayPerView},`
					+`"blocked": false,`
					+`"featured":${this.featured},`
					+`"featuredDateStart":"${this.featuredDateStart}",`
					+`"featuredDateFinish":"${this.featuredDateFinish}",`
					//JANUS
					+`"janus_audio_pt":111,`
					+`"janus_audio_rtp_map":"opus/48000/2",`
					+`"janus_video_pt":126,`
					+`"janus_video_rtp_map":"H264/90000"`
					//JANUS
					+'}');
					console.log(datos);
			this.formData.append('datos', new Blob([JSON.stringify(datos)],{type: "application/json"}));
			const url = `${this.config.backend}/generator/createContent`;
			this.$http.post(url, this.formData,
				{
				headers: {
					Authorization : this.session.token
					}
				}).then((response) => {	
					this.eventBus.$emit('updateMessage', 'Contenido LIVE Creado!');
					this.$router.push("/");
				}).catch((error) => {						
						updateButtonText('Guardar LIVE');
						updateButtonEnable(true);
			});
			}
		},
		updateButtonEnable: function (buttonEnable) {
			this.buttonEnable = buttonEnable;
		},
		updateButtonText: function (buttonText) {
			this.buttonText = buttonText;
		},
		guardarDirector: function (nombre,apellido) {
			if (nombre.trim() !== '' && apellido.trim() !== '') {
				var idd = this.directors.length + 1
				this.directors.push(
					{firstName:nombre, lastName:apellido, isActor:false, isDirector:true}
				)
				this.nombreDirector = ''
				this.apellidoDirector = ''
			} 
		},
		eliminarDirector: function (d) {
			var index = this.directors.indexOf(d)
			this.directors.splice(index, 1)
		},
		guardarActor: function (nombre,apellido) {
			if (nombre.trim() !== '' && apellido.trim() !== '') {
				var ida = this.actors.length + 1
				this.actors.push(
					{firstName:nombre, lastName:apellido, isActor:true, isDirector:false}
				)
				this.nombreActor = ''
				this.apellidoActor = ''
			} 
		},
		eliminarActor: function (a) {
			var index = this.actors.indexOf(a)
			this.actors.splice(index, 1)
		}
	}
}
</script>
