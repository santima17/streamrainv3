<template>
  <div class="container-fluid text-center">
    <div class="row content">
      <div class="col-sm-2 sidenav">
      </div>
      <div class="col-sm-8 text-left">
        <h1>
          {{ stream.name }} <i v-if="titleSpinner && !alert.show" class="fa fa-spinner fa-spin" style="font-size"></i>
        </h1>
        <div>
            <streamrain-sharebutton v-if="stream.id"  ref="sharebutton"
              :session="session"
              :contentId="$route.params.streamId"
              :eventBus="eventBus"
              :config="config"
            >
            </streamrain-sharebutton>
        </div>
        <br>
        <!-- alert -->
        <div class="row">
          <div class="col-sm-12" v-if="alert.show">
            <div v-if="alert.show" class="alert alert-dismissible alert-warning">
              <button class="close" v-on:click="eventBus.$emit('setAlert', {show: false, message: null})">&times;</button>
              <p>Oops!</p>
              <p>{{ alert.message }}</p>
            </div>
          </div>
        </div>
        <!-- alert -->
        <div class="row" id="room">
          <div class="col-sm-12">
            <!-- <video v-on:ended="updateSecond(-1)" ref="video" width="100%" controls /> -->
            <video ref="video" width="100%" controls />
          </div>
        </div>
        <div class="row">
          <div class="col-sm-6 text-left">
            <div>
              <span v-if="stream.type" class="label label-info">{{ stream.type }}</span>
              <span v-if="stream.isPayPerView" class="label label-danger">Pay Per View</span>
            </div>
          </div>
          <div class="col-sm-6 text-right">
            <streamrain-fivestarsrating v-if="stream.id" ref="fivestarsrating"
              :session="session"
              :stream="stream"
              :myRank="myRank"
              :postRank="`${config.backend}/user/content/voteContent`"
              :getRank="`${config.backend}/user/content/rank/${$route.params.streamId}`"
              :eventBus="eventBus"
              :config="config"
            >
            </streamrain-fivestarsrating>
            <streamrain-favbutton v-if="myFav !== null" ref="favbutton"
              :session="session"
              :contentId="$route.params.streamId"
              :myFav="myFav"
              :eventBus="eventBus"
              :config="config"
            >
            </streamrain-favbutton>
          </div>
        </div>
        <div v-if="stream.description">
          <br>
          <b>Description</b>
          <p>{{ stream.description }}</p>
        </div>
        <div class="panel-group">
          <div class="panel panel-default">
            <div class="panel-heading text-center">
              <a data-toggle="collapse" href="#collapse1">More</a>
            </div>
            <div id="collapse1" class="panel-collapse collapse">
              <div class="panel-body">
                <div v-if="stream.directors">
                  <b>Directors</b>
                  <ul class="list-inline">
                    <li v-for="(director, index) in stream.directors" :key="index">
                      {{ director.lastName }}, {{ director.firstName }}
                    </li>
                  </ul>
                </div>
                <div v-if="stream.actors && stream.actors.length > 0">
                  <b>Actors</b>
                  <ul class="list-inline">
                    <li v-for="(actor, index) in stream.actors" :key="index">
                      {{ actor.lastName }}, {{ actor.firstName }}
                    </li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div v-if="comments" class="list-group">
          <a v-for="(comment, index) in comments" :key="index" class="list-group-item">
            <div class="row">
              <div class="col-sm-9">
                <h4 class="list-group-item-heading">{{ comment.userNickname }}</h4>
                <p class="list-group-item-text">
                  <div class="text-info">{{ comment.text }}</div>
                  <div>{{ comment.date }}</div>
                </p>
              </div>
              <div class="col-sm-3 text-right">
                <a v-on:click="activePrivateMessageMode" role="button">Spoiler <i class="glyphicon glyphicon-eye-close"></i></a>
              </div>
            </div>
          </a>
          <div class="input-group margin-bottom-sm">
            <input v-model="messageToSend" class="form-control" type="text" placeholder="Write a comment" autocomplete="off" id="datasend"></input>
            <span v-on:click="sendMessage" class="input-group-addon btn btn-info">Send</span>
          </div>
        </div>
        <streamrain-errorshelper ref="errorshelper"
          :eventBus="eventBus"
          :config="config"
        >
        </streamrain-errorshelper>
        <hr>
      </div>
      <div class="col-sm-2 sidenav">
      </div>
    </div>
  </div>
</template>

<script>
  import FiveStarsRating from '../utils/FiveStarsRating.vue';
  import FavButton from '../utils/FavButton.vue';
  import ShareButton from '../utils/ShareButton.vue';
  import ErrorsHelper from '../utils/ErrorsHelper.vue';
  export default {
    props: [
      'config',
      'eventBus',
      'session',
      'alert'
    ],
    components: {
      'streamrain-fivestarsrating': FiveStarsRating,
      'streamrain-favbutton': FavButton,
      'streamrain-errorshelper': ErrorsHelper,
      'streamrain-sharebutton': ShareButton
    },
    data () {
      return {
        url: null,
        myRank: 0,
        myFav: null,
        sendingRank: false,
        //
        currentStream: null,
        stream: {
          ready: false,
          name: 'Live Stream'
        },
        //
        chatroom: {
          ready: false,
          myId: this.session.nickname,
          messages: [],
          participants: [],
          participantsSelected: [],
          privateMessageMode: false
        },
        messageToSend: null,
        titleSpinner: true,
        lastSecondPosted: 0,
        comments: null
      }
    },
    created () {
      const i = this;
      const streamId = this.$route.params.streamId;
      const session = this.session;

      this.$http.get(`${this.config.backend}/user/content/${streamId}`,
      {
        headers: {
          'Authorization': session.token
        }
      }).then((response) => {
        const newStream = response.body;
        i.updateStream(newStream);
        i.getVodContent();
        i.getMyRank();
        i.getMyFav();
      }).catch((response) => {
        this.$refs.errorshelper.processHttpResponse(response);
      });

      this.$http.get(`${this.config.backend}/user/content/${streamId}`,
      {
        headers: {
          'Authorization': session.token
        }
      }).then((response) => {
        const newStream = response.body;
        i.updateStream(newStream);
        i.getVodContent();
        i.getMyRank();
        i.getMyFav();
      }).catch((response) => {
        this.$refs.errorshelper.processHttpResponse(response);
      });
    },
    mounted () {
    },
    beforeDestroy () {
      this.vtime = null;
      clearInterval(this.vtime);
    },
    methods: {
      updateLastSecondPosted: function (lastSecondPosted) {
        this.lastSecondPosted = lastSecondPosted;
      },
      updateSecond: function (second) {
        if (second === this.lastSecondPosted) return;
        this.updateLastSecondPosted(second);
        if (Math.floor(second) === Math.floor(this.$refs.video.duration)) {
          second = -1;
        }
        const i = this;
        const streamId = i.$route.params.streamId;
        i.$http.post(`${i.config.backend}/user/content/insertDuration`,
        {
          contentID: streamId,
          userNickname: i.session.nickname,
          second
        },
        {
          headers: {
            'Authorization': i.session.token
          }
        }).catch((response) => {
          console.error(JSON.stringify(response));
          this.$refs.errorshelper.processHttpResponse(response);
        });
      },
      getMyRank: function () {
        const i = this;
        const streamId = i.$route.params.streamId;
        i.$http.get(`${i.config.backend}/user/content/rank/${streamId}/${i.session.nickname}`,
        {
          headers: {
            'Authorization': i.session.token
          }
        }).then((response) => {
          i.setMyRank(response.body.pathTokenVOD);
        }).catch((response) => {
          this.$refs.errorshelper.processHttpResponse(response);
        });
      },
      getMyFav: function () {
        const i = this;
        const streamId = i.$route.params.streamId;
        i.$http.get(`${i.config.backend}/user/content/fav/${streamId}/${i.session.nickname}`,
        {
          headers: {
            'Authorization': i.session.token
          }
        }).then((response) => {
          i.setMyFav(response.body.pathTokenVOD);
          console.log(JSON.stringify(response.body));
        }).catch((response) => {
          this.$refs.errorshelper.processHttpResponse(response);
        });
      },
      setMyRank: function (myRank) {
        this.myRank = myRank;
        this.$refs.fivestarsrating.paintStars(myRank);
      },
      setMyFav: function (myFav) {
        this.myFav = (myFav === 'true');
      },
      updateStream: function (stream) {
        this.titleSpinner = false;
        this.stream = stream;
      },
      updateAlert: function (alert) {
        this.alert = alert;
      },
      doTracking: function(){
        const i = this;
        this.intervalid1 = setInterval(function () {
          i.updateSecond(i.$refs.video.currentTime);
        }.bind(this), 5000);
      },
      getVodContent: function() {
        const i = this;
        const config = this.config;
        const streamId = this.$route.params.streamId;
        this.$http.get(`${config.backend}/user/content/view/${streamId}/${i.session.nickname}`,
        {
          headers: {
            'Authorization': i.session.token
          }
        }).then((response) => {
          const url = response.body.pathTokenVOD;
          const player = dashjs.MediaPlayer().create();
          player.initialize(i.$refs.video, url, false);
          i.updateLastSecondPosted(response.body.duration);
          player.seek(response.body.duration);
          i.doTracking();
        }).catch((response) => {
          console.error(JSON.stringify(response))
          if (response.status === 403) {
            // Es PPV y no lo pagó
            return i.$router.push(`/buyPPVContent/${i.$route.params.streamId}`);
          }
          console.log(JSON.stringify(response));
          i.$refs.errorshelper.processHttpResponse(response);
        });
      }
    }
  }
</script>
